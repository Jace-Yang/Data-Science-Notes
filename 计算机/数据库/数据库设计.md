## 设计模式

### E-R模型

实体（Entity）:客观存在并可相互区别的事物称为实体

联系（Relationship）:一个实体内部的联系指组成实体的各属性之间的联系，而实体间的联系指不同实体之间的相互关联

### 数据库设计

**1.数据库表设计**

1. 尽量控制单表数据量的大小，建议控制在 500 万以内。500 万并不是 MySQL 数据库的限制，过大会造成修改表结构、备份、恢复都会有很大的问题，可以用历史数据归档（应用于日志数据），分库分表（应用于业务数据）等手段来控制数据量大小；
2. 谨慎使用 MySQL 分区表。分区表在物理上表现为多个文件，在逻辑上表现为一个表谨慎选择分区键，跨分区查询效率可能更低建议采用物理分表的方式管理大数据；
3. 禁止在数据库中存储图片，文件等大的二进制数据。通常文件很大，会短时间内造成数据量快速增长，数据库进行数据库读取时，通常会进行大量的随机 IO 操作，文件很大时，IO 操作很耗时 通常存储于文件服务器，数据库只存储文件地址信息；
4. 禁止在线上做数据库压力测试。

**2.数据库字段设计**

1. 优先选择符合存储需要的最小的数据类型。列的字段越大，建立索引时所需要的空间也就越大，这样一页中所能存储的索引节点的数量也就越少也越少，在遍历时所需要的 IO 次数也就越多， 索引的性能也就越差；
2. 避免使用 TEXT、BLOB 数据类型，最常见的 TEXT 类型可以存储 64k 的数据；
3. 尽可能把所有列定义为 NOT NULL。

**3.数据库索引设计**

1. 限制每张表上的索引数量，建议单张表索引不超过 5 个；
2. 禁止给表中的每一列都建立单独的索引；
3. 每个 InnoDB 表必须有个主键；
4. 建立索引的目的是：希望通过索引进行数据查找，减少随机 IO，增加查询性能 ，索引能过滤出越少的数据，则从磁盘中读入的数据也就越少。区分度最高的放在联合索引的最左侧（区分度 = 列中不同值的数量 / 列的总行数）。尽量把字段长度小的列放在联合索引的最左侧（因为字段长度越小，一页能存储的数据量越大，IO 性能也就越好）。使用最频繁的列放到联合索引的左侧（这样可以比较少的建立一些索引）。

### 关系模式

第一范式（1NF）

该范式是为了排除重复组的出现，因此要求数据库的每个列的值域都由原子值组成；每个字段的值都只能是单一值。1971 年埃德加·科德提出了第一范式。即表中所有字段都是不可再分的。解决方案：想要消除重复组的话，只要把每笔记录都转化为单一记录即可。

第二范式（2NF）

表中必须存在业务主键，并且非主键依赖于全部业务主键。解决方案：拆分将依赖的字段单独成表。

第三范式（3NF）

表中的非主键列之间不能相互依赖，将不与 PK 形成依赖关系的字段直接提出单独成表即可。

## 存储结构

### 计算机的三级存储体系

根据存储介质的速度和成本，形成三级存储：层次越高，价格越贵，速度越快。

一级存储为易失性存储，二、三级存储都是非易失性存储

访问时间(access time)是从发出读写请求到数据开始传输之间的时间

访问时间 = 寻道时间 + 旋转等待时间

磁盘块：一个逻辑单元，外存与内存之间交换数据的单位。

缓冲区(buffers)是主存储器中用于存储磁盘块的副本的区域。缓冲区中的每个块总有一个副本存放在磁盘上，但是在磁盘上的副本可能比在缓冲区中的副本旧

### 记录组织

文件中组织记录的常用方法有：

堆文件组织、顺序文件组织、多表聚集文件组织、B+树文件组织、散列(hashing)文件组织。

堆文件组织：文件中的记录没有顺序，是堆积起来的。

顺序文件组织：文件中的记录按搜索码值有序。磁盘块内的记录有序，且通过指针将磁盘块逻辑上有序地链接起来。

多表聚集文件组织：在一个块中存储多个关系的相关记录

### 索引与散列

顺序索引：索引中的记录(索引项)基于搜索码值的顺序排列。

散列索引：索引中的记录(索引项)基于搜索码值的散列函数(即哈希函数)的值平均、随机地分布到若干个散列桶中。

顺序索引：稠密索引、稀疏索引。

索引文件：建立了索引的文件。

主索引 或 聚集索引  —— 索引顺序文件。

辅助索引 或 非聚集索引  —— 只能是稠密索引。

多级索引：在索引之上再建立索引。

### B+树索引与散列结构

B+树索引：高效支持范围查询，较高效支持等值查询

一个多级索引，采用平衡树结构，特点是胖而矮

所有结点的结构都相同，每个结点最多有n-1个搜索码值K1, K2, …, Kn-1，以及n个指针P1, P2, …, Pn，每个结点中的搜索码值升序存放

每个非叶结点有⌈n/2⌉到n个孩子结点(根结点除外)，叶结点依次链接起来

B+树文件组织： 叶结点组织文件记录，非叶结点起索引作用

散列结构：高效支持等值查询，不支持范围查询

散列文件组织、散列索引(辅助索引)

散列函数，桶溢出 —— 闭散列、开散列，静态散列、动态散列

 